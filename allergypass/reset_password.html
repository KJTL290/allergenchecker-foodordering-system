<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - AllergyPass</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        .card { background: white; width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; min-height: 400px; }
        .header { background: #c62828; color: white; padding: 25px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.5rem; }

        .body { padding: 25px; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .body.active { display: flex; }

        /* INPUTS & BUTTONS */
        input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; outline: none; }
        input:focus { border-color: #c62828; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: #c62828; color: white; }
        .btn-primary:disabled { background: #cccccc; cursor: not-allowed; }
        .btn-secondary { background: #eee; color: #333; }
        .link { text-align: center; color: #c62828; cursor: pointer; font-size: 0.9rem; margin-top: 10px; display: block; }

        /* PASSWORD TOGGLE */
        .password-wrap { position: relative; width: 100%; }
        .password-wrap input { padding-right: 45px; }
        .toggle-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.6; padding: 0;
        }
        .toggle-btn:hover { opacity: 1; }
    </style>
</head>
<body>

    <div class="card">
        <div class="header">
            <h1>üõ°Ô∏è AllergyPass</h1>
            <p>Reset Your Password</p>
        </div>

        <div class="body">
            <h3 style="text-align:center;">Create New Password</h3>
            <p style="text-align:center; color:#666; font-size:0.9rem; margin:5px 0 15px;">Enter your new password</p>
            
            <div class="password-wrap">
                <input type="password" id="new_pass" placeholder="New Password">
                <button class="toggle-btn" onclick="togglePass('new_pass')">üîç</button>
            </div>
            <div class="password-wrap">
                <input type="password" id="confirm_pass" placeholder="Confirm Password">
                <button class="toggle-btn" onclick="togglePass('confirm_pass')">üîç</button>
            </div>
            
            <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
            <span class="link" onclick="window.location.href='index.html'">Back to Login</span>
        </div>
    </div>

    <script>
        function togglePass(id) {
            const x = document.getElementById(id);
            x.type = x.type === "password" ? "text" : "password";
        }

        function resetPassword() {
            const newPassword = document.getElementById('new_pass').value;
            const confirmPassword = document.getElementById('confirm_pass').value;
            const button = document.querySelector('.btn-primary');

            if (!newPassword || !confirmPassword) {
                return Swal.fire('Error', 'Please fill in all fields', 'error');
            }

            if (newPassword !== confirmPassword) {
                return Swal.fire('Error', 'Passwords do not match', 'error');
            }

            if (newPassword.length < 6) {
                return Swal.fire('Error', 'Password must be at least 6 characters', 'error');
            }

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                return Swal.fire('Error', 'Invalid reset link', 'error');
            }

            // Disable button and show loading state
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = 'Resetting...';

            fetch('api.php?action=reset_password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: token, new_password: newPassword})
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    Swal.fire('Success', data.message, 'success').then(() => {
                        // Clear the form fields and redirect to login
                        document.getElementById('new_pass').value = '';
                        document.getElementById('confirm_pass').value = '';
                        window.location.href = 'index.html';
                    });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error', 'An error occurred while resetting your password. Please try again.', 'error');
            })
            .finally(() => {
                // Restore button state
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // Check if token exists in URL when page loads
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                Swal.fire({
                    title: 'Invalid Reset Link',
                    html: 'The password reset link is invalid or has expired.<br><br><a href="index.html#forgot" style="color:#c62828; text-decoration:none;">Click here to request a new link</a>',
                    icon: 'error',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = 'index.html#forgot';
                });
            } else {
                // Verify token is valid by making a quick API call
                fetch('api.php?action=verify_token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({token: token})
                })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'error') {
                        // Check if this is likely a used token (after successful reset)
                        if (data.message.includes('expired') || data.message.includes('Invalid')) {
                            Swal.fire({
                                title: data.message,
                                html: 'Your password may have already been reset or the link has expired.<br><br><a href="index.html#forgot" style="color:#c62828; text-decoration:none;">Request a new password reset</a>',
                                icon: 'info', // Changed to info since this is expected behavior after reset
                                confirmButtonText: 'Request New Link'
                            }).then(() => {
                                window.location.href = 'index.html#forgot';
                            });
                        } else {
                            Swal.fire({
                                title: data.message,
                                html: '<br><a href="index.html#forgot" style="color:#c62828; text-decoration:none;">Click here to request a new link</a>',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = 'index.html#forgot';
                            });
                        }
                    } else {
                        // Token is valid, allow user to reset password
                        console.log('Token is valid, user can proceed with password reset');
                    }
                })
                .catch(error => {
                    console.error('Token verification error:', error);
                    Swal.fire({
                        title: 'Connection Error',
                        html: 'Unable to verify reset link. Please check your connection and try again.<br><br><a href="index.html#forgot" style="color:#c62828; text-decoration:none;">Click here to request a new link</a>',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = 'index.html#forgot';
                    });
                });
            }
        };
    </script>
</body>
</html>