<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - AllergyPass</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        .card { background: white; width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; min-height: 400px; }
        .header { background: #c62828; color: white; padding: 25px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.5rem; }

        .body { padding: 25px; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .body.active { display: flex; }

        /* INPUTS & BUTTONS */
        input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; outline: none; }
        input:focus { border-color: #c62828; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: #c62828; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .link { text-align: center; color: #c62828; cursor: pointer; font-size: 0.9rem; margin-top: 10px; display: block; }

        /* PASSWORD TOGGLE */
        .password-wrap { position: relative; width: 100%; }
        .password-wrap input { padding-right: 45px; }
        .toggle-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.6; padding: 0;
        }
        .toggle-btn:hover { opacity: 1; }
    </style>
</head>
<body>

    <div class="card">
        <div class="header">
            <h1>üõ°Ô∏è AllergyPass</h1>
            <p>Reset Your Password</p>
        </div>

        <div class="body">
            <h3 style="text-align:center;">Create New Password</h3>
            <p style="text-align:center; color:#666; font-size:0.9rem; margin:5px 0 15px;">Enter your new password</p>
            
            <div class="password-wrap">
                <input type="password" id="new_pass" placeholder="New Password">
                <button class="toggle-btn" onclick="togglePass('new_pass')">üîç</button>
            </div>
            <div class="password-wrap">
                <input type="password" id="confirm_pass" placeholder="Confirm Password">
                <button class="toggle-btn" onclick="togglePass('confirm_pass')">üîç</button>
            </div>
            
            <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
            <span class="link" onclick="window.location.href='index.html'">Back to Login</span>
        </div>
    </div>

    <script>
        function togglePass(id) {
            const x = document.getElementById(id);
            x.type = x.type === "password" ? "text" : "password";
        }

        function resetPassword() {
            const newPassword = document.getElementById('new_pass').value;
            const confirmPassword = document.getElementById('confirm_pass').value;
            
            if (!newPassword || !confirmPassword) {
                return Swal.fire('Error', 'Please fill in all fields', 'error');
            }
            
            if (newPassword !== confirmPassword) {
                return Swal.fire('Error', 'Passwords do not match', 'error');
            }
            
            if (newPassword.length < 6) {
                return Swal.fire('Error', 'Password must be at least 6 characters', 'error');
            }
            
            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                return Swal.fire('Error', 'Invalid reset link', 'error');
            }
            
            fetch('api.php?action=reset_password', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: token, new_password: newPassword}) 
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    Swal.fire('Success', data.message, 'success').then(() => {
                        window.location.href = 'index.html';
                    });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            });
        }
        
        // Check if token exists in URL when page loads
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                Swal.fire('Error', 'Invalid reset link. Token is missing.', 'error');
            }
        };
    </script>
</body>
</html>